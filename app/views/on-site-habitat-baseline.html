{% extends "layouts/map-layout.html" %}
{% from "govuk/components/back-link/macro.njk" import govukBackLink %}

{% set pageName="On-site Habitat Baseline Map" %}

{% block pageTitle %}
  On-site Habitat Baseline Map - GOV.UK Prototype Kit
{% endblock %}

{% block backLink %}
  {{ govukBackLink({
    href: "/define-red-line-boundary",
    text: "Back"
  }) }}
{% endblock %}

{% block mapAttributes %}{% endblock %}

{% block mapAreaDisplay %}
  <div class="map-area-display__row">
    <span class="map-area-display__label">Boundary area:</span>
    <span class="map-area-display__data" id="boundary-area">--</span>
  </div>
  <div class="map-area-display__row">
    <span class="map-area-display__label">Parcels total:</span>
    <span class="map-area-display__data" id="total-area">0.00</span>
  </div>
  <div class="map-area-display__row">
    <span class="map-area-display__label">Remaining:</span>
    <span class="map-area-display__data map-area-display__data--warning" id="remaining-area-value">--</span>
  </div>
{% endblock %}

{% block helpContent %}
  <p class="govuk-body">Draw habitat parcels within your red line boundary. Each parcel must be completely within the boundary and must not overlap with other parcels.</p>

  <h3 class="govuk-heading-s govuk-!-margin-top-4">Option 1: Fill Parcel (recommended)</h3>
  <p class="govuk-body">Select existing OS map features within your boundary:</p>
  <ol class="govuk-list govuk-list--number">
    <li><strong>Click "Fill parcel"</strong> to start selection mode</li>
    <li>Click on a <strong>field, land area, or other OS polygon</strong> within the boundary</li>
    <li>The selected area will be added as a new habitat parcel</li>
    <li>Continue clicking to add more parcels</li>
    <li>Click <strong>"Finish fill"</strong> when done to use other tools (Slice, Draw)</li>
  </ol>
  <div class="govuk-inset-text">
    <strong>Note:</strong> Only polygons that are completely within the red-line boundary can be selected.
  </div>

  <h3 class="govuk-heading-s govuk-!-margin-top-4">Option 2: Draw Parcel</h3>
  <p class="govuk-body">Manually draw parcels with intelligent snapping:</p>
  <ol class="govuk-list govuk-list--number">
    <li>Your red line boundary is shown on the map (red dashed line)</li>
    <li><strong>Click "Draw parcel"</strong> to start drawing a new habitat parcel</li>
    <li>Draw the parcel using intelligent snapping to ensure precise boundaries</li>
    <li>The parcel must be <strong>completely within</strong> the red line boundary</li>
    <li>Parcels must <strong>not overlap</strong> with each other</li>
    <li>You can draw <strong>multiple parcels</strong> - each will be shown in a different colour</li>
  </ol>

  <h3 class="govuk-heading-s govuk-!-margin-top-4">Visual indicators:</h3>
  <ul class="govuk-list govuk-list--bullet">
    <li><strong style="color: #d4351c;">Small red dots</strong> = boundary corners (always visible as reference points)</li>
    <li><strong style="color: #d4351c;">Large red circle</strong> = cursor snapping to boundary corner (highest priority)</li>
    <li><strong style="color: #ae2573;">Large magenta circle</strong> = cursor snapping to parcel corner (exact match)</li>
    <li><strong style="color: #ff8c00;">Orange circle</strong> = snapping to edge or OS feature</li>
    <li><strong style="color: #0096ff;">Small blue circle</strong> = no snapping (free placement)</li>
  </ul>
  <div class="govuk-inset-text govuk-!-margin-top-2">
    <strong>Tip:</strong> Boundary and parcel corner snapping has the highest priority - it will always trigger before OS features for precise alignment.
  </div>

  <h3 class="govuk-heading-s govuk-!-margin-top-4">Slicing parcels:</h3>
  <p class="govuk-body-s">Use the <strong>Slice</strong> tool to split the boundary or an existing parcel into two separate parcels:</p>
  <ol class="govuk-list govuk-list--number">
    <li><strong>Click "Slice polygon"</strong> to enter slice mode</li>
    <li>Click on a <strong>vertex (corner point)</strong> of the red-line boundary or an existing parcel</li>
    <li>A preview line will appear from your selected starting point</li>
    <li>Click on a <strong>different vertex</strong> of the <strong>same polygon</strong> to complete the slice</li>
    <li>Two new parcels will be created from the split</li>
  </ol>
  <div class="govuk-inset-text govuk-!-margin-top-2">
    <strong>Slice rules:</strong>
    <ul class="govuk-list govuk-list--bullet govuk-!-margin-top-2">
      <li>Both start and end points must be on vertices (corner points)</li>
      <li>Both points must be on the same polygon</li>
      <li>Adjacent vertices cannot be used (would create invalid shapes)</li>
      <li>Press <strong>Escape</strong> or click "Cancel slice" to cancel</li>
    </ul>
  </div>

  <div class="govuk-inset-text govuk-!-margin-top-4">
    <strong>Validation rules:</strong>
    <ul class="govuk-list govuk-list--bullet govuk-!-margin-top-2">
      <li>All parcels must be inside the red line boundary</li>
      <li>Parcels cannot overlap with each other</li>
      <li>Invalid parcels will be rejected with an error message</li>
    </ul>
  </div>
{% endblock %}

{% block mapScript %}
  <script src="/public/javascripts/map-habitat-parcels.js"></script>
{% endblock %}
