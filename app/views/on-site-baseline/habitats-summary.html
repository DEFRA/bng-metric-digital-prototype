{% extends "layouts/main.html" %}

{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/button/macro.njk" import govukButton %}

{% set pageName = "On-site baseline habitats" %}

{% block pageTitle %}{{ pageName }} – {{ serviceName }} – GOV.UK{% endblock %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/OrdnanceSurvey/os-api-branding@latest/os-api-branding.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v10.6.0/ol.css" />
  <style>
    .map-preview-container {
      width: 100%;
      height: 400px;
      margin: 30px 0;
      border: 2px solid #b1b4b6;
      position: relative;
    }

    .map-preview-container .map-preview {
      width: 100%;
      height: 100%;
    }

    @media (min-width: 641px) {
      .map-preview-container {
        height: 500px;
      }
    }
  </style>
{% endblock %}

{% block content %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">

    <span class="govuk-caption-l">On-site baseline</span>
    <h1 class="govuk-heading-l">{{ pageName }}</h1>

    <p class="govuk-body">{{ baselineSummary.parcelCountMessage }}</p>

    {{ govukSummaryList({
      rows: [
        {
          key: {
            text: "Site area"
          },
          value: {
            text: siteSummary.totalAreaHectares
          }
        },
        {
          key: {
            text: "Local Planning Authority"
          },
          value: {
            text: siteSummary.localPlanningAuthority
          }
        },
        {
          key: {
            text: "National Character Area"
          },
          value: {
            text: siteSummary.nationalCharacterArea
          }
        }
      ]
    }) }}

    <div class="map-preview-container">
      <div id="map-preview" class="map-preview" role="img" aria-label="Map showing habitat parcels within the site boundary">
        <p class="govuk-visually-hidden">
          Map preview showing {{ habitatParcels | length }} habitat parcel{% if habitatParcels | length != 1 %}s{% endif %} 
          within the site boundary.
        </p>
      </div>
    </div>

    <h2 class="govuk-heading-m">Habitat parcels</h2>

    {{ govukTable({
      firstCellIsHeader: true,
      head: [
        { text: "Parcel reference" },
        { text: "Area (hectares)" },
        { text: "Habitat" },
        { text: "Status" },
        { text: "Action", classes: "govuk-visually-hidden" }
      ],
      rows: tableRows
    }) }}

    {{ govukButton({
      text: "Start adding habitat details",
      href: actions.startFirstParcel.url
    }) }}

  </div>
</div>

{# Hidden data elements for map initialization #}
<script type="application/json" id="geometries-data">{{ mapData | dump | safe }}</script>

{% endblock %}

{% block pageScripts %}
  <script src="https://cdn.jsdelivr.net/gh/OrdnanceSurvey/os-api-branding@latest/os-api-branding.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/proj4@2.9.0/dist/proj4.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ol@v10.6.0/dist/ol.js"></script>
  <script src="https://unpkg.com/ol-mapbox-style@13.1.0/dist/olms.js"></script>
  <script>
    // Register EPSG:27700 (British National Grid) projection
    proj4.defs('EPSG:27700', '+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +towgs84=446.448,-125.157,542.06,0.15,0.247,0.842,-20.489 +units=m +no_defs');
    ol.proj.proj4.register(proj4);
  </script>
  <script src="/public/javascripts/defra-map-lib/event-emitter.js"></script>
  <script src="/public/javascripts/defra-map-lib/geometry-validation.js"></script>
  <script src="/public/javascripts/defra-map-lib/defra-map-client.js"></script>
  <script src="/public/javascripts/map-habitats-summary.js"></script>
{% endblock %}
