{% extends "layouts/main.html" %}

{% from "govuk/components/notification-banner/macro.njk" import govukNotificationBanner %}
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{% from "govuk/components/inset-text/macro.njk" import govukInsetText %}
{% from "govuk/components/button/macro.njk" import govukButton %}

{% set pageName = "Check your site boundary and habitat parcels" %}

{% block pageTitle %}{{ pageName }} – {{ serviceName }} – GOV.UK{% endblock %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@10.2.1/ol.css" />
  <style>
    .map-preview-container {
      margin-bottom: 30px;
    }
    .map-preview {
      width: 100%;
      height: 400px;
      border: 2px solid #b1b4b6;
      background: #f3f2f1;
    }
    .map-legend {
      margin-top: 15px;
      padding: 15px;
      background: #f3f2f1;
      border-left: 4px solid #1d70b8;
    }
    .map-legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .map-legend-item:last-child {
      margin-bottom: 0;
    }
    .legend-swatch {
      width: 24px;
      height: 24px;
      margin-right: 10px;
      border: 1px solid #0b0c0c;
    }
    .legend-swatch--boundary {
      background: transparent;
      border: 2px dashed #d4351c;
    }
    .legend-swatch--parcels {
      background: rgba(29, 112, 184, 0.3);
      border: 2px solid #1d70b8;
    }
    .coverage-success {
      color: #00703c;
      font-weight: 700;
    }
  </style>
{% endblock %}

{% block content %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">

    {% set bannerHtml %}
      <p class="govuk-notification-banner__heading">{{ uploadSummary.layerCountMessage }}</p>
    {% endset %}

    {{ govukNotificationBanner({
      type: "success",
      titleText: "Success",
      html: bannerHtml
    }) }}

    <h1 class="govuk-heading-l">{{ pageName }}</h1>

    <p class="govuk-body">
      We found the following layers in your file.
    </p>

    <!-- Map Preview -->
    <div class="map-preview-container">
      <div id="map-preview" class="map-preview" 
           data-boundary-layer="{{ boundaryLayerName }}"
           data-parcels-layer="{{ parcelsLayerName }}">
      </div>
      <div class="map-legend">
        <div class="map-legend-item">
          <div class="legend-swatch legend-swatch--boundary"></div>
          <span>Site boundary</span>
        </div>
        <div class="map-legend-item">
          <div class="legend-swatch legend-swatch--parcels"></div>
          <span>Habitat parcels ({{ layers.habitatParcels.polygonCount }})</span>
        </div>
      </div>
    </div>

    <!-- Layers Identified -->
    <h2 class="govuk-heading-m">Layers identified</h2>

    {{ govukSummaryList({
      rows: [
        {
          key: {
            text: "Site boundary"
          },
          value: {
            html: '<p class="govuk-body govuk-!-margin-bottom-1">' + layers.siteBoundary.polygonCount + ' polygon</p>
                   <p class="govuk-body govuk-!-margin-bottom-1">' + layers.siteBoundary.areaHa + ' hectares</p>
                   <p class="govuk-body govuk-!-margin-bottom-0 govuk-!-font-size-16">Layer: ' + layers.siteBoundary.layerName + '</p>'
          },
          actions: {
            items: [
              {
                href: "#",
                text: "Change",
                visuallyHiddenText: "site boundary layer"
              }
            ]
          }
        },
        {
          key: {
            text: "Habitat parcels"
          },
          value: {
            html: '<p class="govuk-body govuk-!-margin-bottom-1">' + layers.habitatParcels.polygonCount + ' polygons</p>
                   <p class="govuk-body govuk-!-margin-bottom-1">' + layers.habitatParcels.areaHa + ' hectares</p>
                   <p class="govuk-body govuk-!-margin-bottom-0 govuk-!-font-size-16">Layer: ' + layers.habitatParcels.layerName + '</p>'
          },
          actions: {
            items: [
              {
                href: "#",
                text: "Change",
                visuallyHiddenText: "habitat parcels layer"
              }
            ]
          }
        }
      ]
    }) }}

    <!-- Coverage Check -->
    {% if coverage.isFull %}
      {{ govukInsetText({
        html: '<span class="coverage-success">✓ Full coverage</span> – Your habitat parcels cover the entire site boundary.'
      }) }}
    {% endif %}

    <!-- Location Information -->
    <h2 class="govuk-heading-m">Location information</h2>

    <p class="govuk-body govuk-!-font-size-16 govuk-!-margin-bottom-2">Looked up automatically</p>

    {{ govukSummaryList({
      classes: "govuk-summary-list--no-border",
      rows: [
        {
          key: {
            text: "Local Planning Authority"
          },
          value: {
            text: location.lpaName
          }
        },
        {
          key: {
            text: "National Character Area"
          },
          value: {
            text: location.nationalCharacterArea
          }
        },
        {
          key: {
            text: "Local Nature Recovery Strategy"
          },
          value: {
            text: location.lnrsName
          }
        }
      ]
    }) }}

    <form method="post" action="/on-site-baseline/confirm-layers">
      {{ govukButton({
        text: "Continue"
      }) }}
    </form>

  </div>
</div>

<!-- Store geometries for JavaScript -->
<script id="geometries-data" type="application/json">{{ geometries | dump | safe }}</script>
<script id="boundary-layer-name" type="text/plain">{{ boundaryLayerName }}</script>
<script id="parcels-layer-name" type="text/plain">{{ parcelsLayerName }}</script>

{% endblock %}

{% block pageScripts %}
  <script src="https://cdn.jsdelivr.net/npm/ol@10.2.1/dist/ol.js"></script>
  <script src="/public/javascripts/map-confirm-layers.js"></script>
{% endblock %}
